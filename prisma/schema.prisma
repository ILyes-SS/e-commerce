// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// 3. --- Enums ---
enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  CANCELLED
}

// 4. --- Models ---

// --- User & Auth ---
model User {
  id       String         @id @default(uuid())
  role     Role           @default(USER)
  email    String         @unique
  name     String
  // Relations
  orders   Order[]
  cart     Cart?
  wishlist Wishlist[]
}

// --- Product & Catalog ---
model Product {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  image       String // Primary thumbnail
  description String    @db.Text
  weight      Float?
  dimension   Float?
  lowStock    Int       @default(5)
  // Relations
  category    Category  @relation(fields: [categoryId], references: [id])
  categoryId  String
  brand       Brand     @relation(fields: [brandId], references: [id])
  brandId     String
  variants    ProductVariant[]
  images      ProductImage[]
  trending    Trending?
  wishlist    Wishlist[]
}

model ProductVariant {
  id             String    @id @default(uuid())
  price          Float
  compareAtPrice Float?
  color          String?
  size           String?
  unit           String? // e.g., 'kg', 'pack of 6'
  createdAt      DateTime @default(now())
  // Relations
  product        Product   @relation(fields: [prodId], references: [id])
  prodId         String
  stock          Stock? // 1-to-1 relation with Stock
  cartItems      CartItem[]
  orderItems     OrderProd[]
}

model ProductImage {
  id        String  @id @default(uuid())
  imageUrl  String
  sortOrder Int
  // Relations
  product   Product @relation(fields: [productId], references: [id])
  productId String
}

model Stock {
  id    String @id @default(uuid())
  qty   Int
  // Relations
  productVariant ProductVariant @relation(fields: [prodVariantId], references: [id])
  prodVariantId  String         @unique
}

model Category {
  id    String @id @default(uuid())
  title String
  slug String? @unique
  image String?
  // Self-relation for subcategories
  parentCategory Category?   @relation("Subcategories", fields: [parentCategoryId], references: [id])
  parentCategoryId  String?
  subcategories  Category[]  @relation("Subcategories")
  // Relations
  products       Product[]
  brands         Brand[]
}

model Brand {
  id    String @id @default(uuid())
  title String
  // Relations
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String
  products   Product[]
}

// --- Shopping Cart (Temporary) ---
model Cart {
  id        String     @id @default(uuid())
  createdAt DateTime   @default(now())
  // Relations
  user      User?      @relation(fields: [userId], references: [id])
  userId    String?    @unique // Can be null for guest carts
  items     CartItem[]
}

model CartItem {
  id       String @id @default(uuid())
  quantity Int
  // Relations
  cart     Cart   @relation(fields: [cartId], references: [id])
  cartId   String
  productVariant ProductVariant @relation(fields: [prodVariantId], references: [id])
  prodVariantId  String
  @@unique([cartId, prodVariantId])
}

// --- Orders (Permanent) ---
model Order {
  id     String   @id @default(uuid())
  name   String // Customer name
  email  String
  phone  String
  total  Float // Final price
  status OrderStatus @default(PENDING)
  // Relations
  wilaya     Wilaya     @relation(fields: [wilayaId], references: [id])
  wilayaId   String
  customer   User?      @relation(fields: [customerId], references: [id])
  customerId String? // Null for guest orders
  items      OrderProd[]
}

model OrderProd {
  id              String   @id @default(uuid())
  quantity        Int
  priceAtPurchase Float // Price snapshot
  // Relations
  order           Order    @relation(fields: [orderId], references: [id])
  orderId         String
  productVariant  ProductVariant @relation(fields: [prodVariantId], references: [id])
  prodVariantId   String
}

model Wilaya {
  id    String  @id @default(uuid())
  name  String  @unique
  price Float // Delivery cost
  // Relations
  orders Order[]
}

// --- Admin & Marketing ---
model CarouselSlide {
  id        String  @id @default(uuid())
  imageUrl  String
  title     String?
  linkUrl   String?
  sortOrder Int
}

model Trending {
  id      String  @id @default(uuid())
  // Relations
  product Product @relation(fields: [prodId], references: [id])
  prodId  String  @unique // <-- ADD THIS
}

model Wishlist {
  id String @id @default(uuid())
  // Relations
  user   User   @relation(fields: [userId], references: [id])
  userId String
  product Product @relation(fields: [prodId], references: [id])
  prodId  String

  @@unique([userId, prodId]) // A user can only like a product once
}

